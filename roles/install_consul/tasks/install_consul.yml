---

- name: Download Consul binary
  unarchive:
    src:  "{{ consul_dist }}"
    remote_src: yes
    dest: /bin/
    owner: root
    group: root
    mode: '0755'
    
- name: Run autocomplete-install for consul
  command: /bin/consul -autocomplete-install
  register: result
  failed_when:
    - '"Error executing CLI" not in result.stderr'
 
- name: Create consul-related folders
  file: 
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0755'
    state: directory
  loop: 
    - /etc/consul.d
    - /var/consul/data

- name: Create Consul encrypt key
  command: consul keygen
  register: consul_keygen_key
  run_once: true
  
- name: Copy consul config template
  template:
    src: config.j2.json
    dest: /etc/consul.d/config.json
    mode: '0755'
  
- name: Copy consul systemd template
  template:
    src: consul.service.j2
    dest: /etc/systemd/system/consul.service
    mode: '0644'
    force: yes

- name: Delete old files and dirs (if exists)
  file:
    state: absent
    path: "{{ item }}"
  loop:
    - "{{ ssl_dir }}"
    - "{{ ca_dir }}"

- name: Run consul through systemctl
  systemd:
    state: restarted
    daemon_reload: yes
    name: consul





